---
title: "Wasteload background water quality analysis"
author: "Your Name Here"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: yeti
    toc: yes
    toc_float:
      toc_collapsed: yes
  pdf_document:
    toc: yes
editor_options:
  markdown:
    wrap: 72
---


```{r, global-chunk-opts, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, include=FALSE
)
```

# Knit to PDF

Note - to knit to PDF, you will need to install a version of latex in
RStudio and phantomjs (only need to do this once). To do this run
`` tinytex::install_tinytex() & `webshot::install_phantomjs()` `` in the
R console. You can then knit to PDF clicking the dropdown menu beside
the knit button in the above menu bar.



# Packages

Install wasteloadR & wqTools if necessary.

```{r, eval=F}
devtools::install_github('utah-dwq/wqTools', upgrade = c('never')) 
devtools::install_github('utah-dwq/wasteloadR', upgrade = c('never'))
#Note- recommend updating other packages independently
```

```{r, libs, message=FALSE, warnings=FALSE}
library(dataRetrieval)
library(wqTools)
library(wasteloadR)
library(dplyr)
library(plotly)
library(knitr)
library(writexl)
library(leaflet)
```

# User inputs

## Select a permit ID
Use the permit selection gadget, then update permit_id. If you already know your permit ID, you can skip selectPermit().
```{r}
pid=selectPermit()
#pid="UT0021741"
permit_location=subset(wasteloadR::permits_coords, permit_id==pid)
```

## Find and select sites
Use the findSites() gadget to find and select permit, monitoring location, and a gauge location if desired for mapping.
```{r}
sites=findSites()
knitr::kable(sites)
```

## Location map
```{r}
map_sites=within(sites, {
	lab=paste0(
		'<p>',
		'<br />', "Site ID: ", site_id,
		'<br />', "Site name: ", site_name,
		'<br />', "Site type: ", type,
		'<br />', "Visit count: ", visit_count)
	color=NA
	color[type=="Monitoring location"]="purple"
	color[type=="Permit"]="orange"
	color[type=="Gauge"]="blue"
})
baseMap() %>%
	addCircleMarkers(data=map_sites, lat=~lat, lng=~long, options = pathOptions(pane = "markers"), group="Sites",
		color = ~color, opacity=0.8, layerId=~site_id,
		label = lapply(map_sites$lab, HTML) # crashes if only one site is selected for lapply
	) %>%  
	addLegend("topright", colors=c("purple","orange","blue"), labels=c("Monitoring location", "Permit", "USGS gauge")) %>%
	fitBounds(min(map_sites$long), min(map_sites$lat), max(map_sites$long), max(map_sites$lat))
```




## Read data
```{r}
echo_data=readECHO_ec(p_id="UT0021741", start_date="01/01/2000", end_date="10/12/2022", print=F)
wqp_sites=readWQP(type="sites", siteid=subset(sites, type=="Monitoring location")$site_id)
wqp_res=readWQP(type="result", siteid=subset(sites, type=="Monitoring location")$site_id)
wqp_data=merge(wqp_sites, wqp_res)
```

## Water quality summary statistics (thinking of also making a gadget option(s) for this)
### Subset data to desired sites, dates, parameters, etc.
```{r}
summ_data=subset(wqp_data, 
	MonitoringLocationIdentifier %in% c("UTAHDWQ_WQX-4990060", "UTAHDWQ_WQX-4990070", "UTAHDWQ_WQX-4990080") & 
	CharacteristicName %in% c("Total suspended solids","Phosphate-phosphorus","Total dissolved solids","pH","Temperature, water")
)

```

### Check parameters, units, fractions
Table of params, activity types, units, & fractions.
```{r}
table_data=unique(data.frame(summ_data[,c("CharacteristicName","ActivityTypeCode","ResultSampleFractionText","ResultMeasure.MeasureUnitCode")]))
knitr::kable(table_data[order(table_data$CharacteristicName),])
```

Convert units if necessary.
Cleanup stuff (e.g. remove lab pH values).
Assign seasons.


### Fill non-detects
```{r}
knitr::kable(table(summ_data$ResultDetectionConditionText, exclude=NULL))
summ_data=within(summ_data, {
	ResultMeasureValue=ifelse(ResultDetectionConditionText %in% "Not Detected", DetectionQuantitationLimitMeasure.MeasureValue/2, ResultMeasureValue)
})
```

### Summary stats (using dplyr group_by() %>% summarize() pattern)
```{r}
wasteload_stats=summ_data %>% 
	group_by(MonitoringLocationIdentifier, MonitoringLocationName, SampleCollectionMethod.MethodName, CharacteristicName, ResultSampleFractionText, ResultMeasure.MeasureUnitCode) %>%
	summarize(min=min(ResultMeasureValue, na.rm=T), median=median(ResultMeasureValue, na.rm=T), mean=mean(ResultMeasureValue, na.rm=T), max=max(ResultMeasureValue, na.rm=T), 
		pctile20=quantile(ResultMeasureValue, 0.20, na.rm=T), pctile80=quantile(ResultMeasureValue, 0.80, na.rm=T), samp_count=dplyr::n(), .groups="drop")

DT::datatable(data.frame(lapply(wasteload_stats, as.factor)),
	selection='none', rownames=FALSE, filter="top",
	options = list(dom = 't', paging = FALSE)
) %>%
DT::formatRound(columns=c("min","pctile20","median","mean","pctile80","max"), digits=2) %>%
DT::formatRound(columns=c("samp_count"), digits=0)
```

# Figures

Based on a visual inspection, you may want to subset the data down to a
specific time period, make custom season assignments, or take other QAQC
actions.

```{r, timeseries, fig.cap=paste0(SiteName, ' discharge time series.')}
plot_ly(data=gauge_data, x=~Date, y=~discharge_cfs, type='scatter', mode='lines') %>% 
  layout(
    xaxis = list(title = ''),
    yaxis = list(title = 'Discharge (cfs)')
	) %>% 	
	config(displaylogo = FALSE,
		modeBarButtonsToRemove = c(
			'sendDataToCloud',
			'hoverClosestCartesian',
			'hoverCompareCartesian',
			'lasso2d',
			'select2d'
		)
	)

```

```{r, boxplots, fig.cap=paste0(SiteName, ' annual, monthly, and seasonal boxplots.')}
plot_ly() %>% 
  add_trace(data=gauge_data, type='box', x=~wateryear, y=~discharge_cfs) %>% 
  layout(title = "",
		yaxis = list(title = 'Discharge (cfs)'),
		xaxis = list(side = 'left', title = 'Water Year', showline=TRUE)
	) %>% 
	config(displaylogo = FALSE,
		modeBarButtonsToRemove = c(
			'sendDataToCloud',
			'hoverClosestCartesian',
			'hoverCompareCartesian',
			'lasso2d',
			'select2d'
		)
	)

plot_ly() %>% 
  add_trace(data=gauge_data, type='box', x=~season, y=~discharge_cfs) %>% 
  layout(title = "",
		yaxis = list(title = 'Discharge (cfs)'),
		xaxis = list(side = 'left', title = 'Season', showline=TRUE)
	) %>% 
	config(displaylogo = FALSE,
		modeBarButtonsToRemove = c(
			'sendDataToCloud',
			'hoverClosestCartesian',
			'hoverCompareCartesian',
			'lasso2d',
			'select2d'
		)
	)

plot_ly() %>% 
  add_trace(data=gauge_data, type='box', x=~month, y=~discharge_cfs) %>% 
  layout(title = "",
		yaxis = list(title = 'Discharge (cfs)'),
		xaxis = list(side = 'left', title = 'Month', showline=TRUE)
	) %>% 
	config(displaylogo = FALSE,
		modeBarButtonsToRemove = c(
			'sendDataToCloud',
			'hoverClosestCartesian',
			'hoverCompareCartesian',
			'lasso2d',
			'select2d'
		)
	)


```
